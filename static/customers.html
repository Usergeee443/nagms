<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mijozlar - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><div class="sidebar-logo">NGMS</div></div>
        <nav class="sidebar-nav">
            <a href="/dashboard.html" class="nav-item"><span class="nav-icon">üìä</span>Dashboard</a>
            <a href="/products.html" class="nav-item"><span class="nav-icon">üì¶</span>Mahsulotlar</a>
            <a href="/customers.html" class="nav-item active"><span class="nav-icon">üë•</span>Mijozlar</a>
            <a href="/sales.html" class="nav-item"><span class="nav-icon">üí∞</span>Savdo</a>
            <a href="/maps.html" class="nav-item"><span class="nav-icon">üìç</span>Xaritalar</a>
            <a href="/ai.html" class="nav-item"><span class="nav-icon">ü§ñ</span>AI Tahlil</a>
        </nav>
        <div class="sidebar-footer"><button class="btn btn-danger" style="width:100%" onclick="logout()">Chiqish</button></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Mijozlar</h1>
                <p class="page-subtitle">Barcha mijozlar ro'yxati</p>
            </div>
            <button class="btn btn-primary" onclick="showModal()">
                ‚ûï Yangi Mijoz
            </button>
        </div>

        <!-- Statistikalar -->
        <div class="grid grid-2 mb-6">
            <div class="stat-card gradient-green">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="stat-label">Jami Mijozlar</p>
                        <p class="stat-value" id="totalCustomers">0</p>
                    </div>
                    <span class="stat-icon">üë•</span>
                </div>
            </div>
            <div class="stat-card gradient-blue">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="stat-label">Xaritada</p>
                        <p class="stat-value" id="mappedCustomers">0</p>
                    </div>
                    <span class="stat-icon">üìç</span>
                </div>
            </div>
        </div>

        <!-- Tez Qo'shish -->
        <div class="card mb-6">
            <div class="card-header">
                <h3 class="card-title">‚ö° Tez Mijoz Qo'shish</h3>
            </div>
            <div class="card-body">
                <form id="quickCustomerForm">
                    <div class="grid grid-4 mb-4">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Ismi *</label>
                            <input type="text" id="quickName" class="form-input" required placeholder="Mijoz ismi">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Qo'shimcha nomi</label>
                            <input type="text" id="quickAdditionalName" class="form-input" placeholder="Ixtiyoriy">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Telefon raqam</label>
                            <input type="tel" id="quickPhone" class="form-input" placeholder="+998 90 123 45 67">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Manzil</label>
                            <input type="text" id="quickAddress" class="form-input" placeholder="Manzil">
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            ‚ûï Qo'shish
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Mijozlar Jadvali -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üë• Mijozlar Ro'yxati</h3>
                <span class="badge badge-info" id="customerCount">0 ta</span>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ismi</th>
                                <th>Qo'shimcha nomi</th>
                                <th>Telefon</th>
                                <th>Manzil</th>
                                <th>Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable">
                            <tr>
                                <td colspan="5" class="text-center p-4">
                                    <div class="spinner" style="margin: 0 auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-backdrop" onclick="hideModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Yangi Mijoz</h3>
                <button class="modal-close" onclick="hideModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="customerId">
                    <div class="form-group">
                        <label class="form-label">Ismi *</label>
                        <input type="text" id="customerName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Qo'shimcha nomi</label>
                        <input type="text" id="customerAdditionalName" class="form-input" placeholder="Ixtiyoriy">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon raqam</label>
                        <input type="tel" id="customerPhone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Manzil</label>
                        <textarea id="customerAddress" class="form-input" rows="2"></textarea>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">Latitude (Xarita uchun)</label>
                            <input type="number" step="0.0000001" id="customerLatitude" class="form-input" placeholder="39.6547">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Longitude (Xarita uchun)</label>
                            <input type="number" step="0.0000001" id="customerLongitude" class="form-input" placeholder="66.9597">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal()">Bekor qilish</button>
                <button class="btn btn-primary" onclick="saveCustomer()">Saqlash</button>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        // Auth check
        if (!getAuthToken()) {
            window.location.href = '/login.html';
        }

        let editingId = null;

        function logout() {
            removeAuthToken();
            window.location.href = '/login.html';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function showModal(customer = null) {
            editingId = customer ? customer.id : null;
            document.getElementById('modalTitle').textContent = customer ? 'Mijozni tahrirlash' : 'Yangi Mijoz';
            
            if (customer) {
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerAdditionalName').value = customer.additional_name || '';
                document.getElementById('customerPhone').value = customer.phone || '';
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerLatitude').value = customer.latitude || '';
                document.getElementById('customerLongitude').value = customer.longitude || '';
            } else {
                document.getElementById('customerForm').reset();
            }
            
            document.getElementById('customerModal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('customerModal').classList.remove('active');
            editingId = null;
        }

        async function loadCustomers() {
            try {
                const customers = await customersAPI.getAll();
                document.getElementById('customerCount').textContent = customers.length + ' ta';
                document.getElementById('totalCustomers').textContent = customers.length;
                document.getElementById('mappedCustomers').textContent = customers.filter(c => c.latitude && c.longitude).length;
                
                const tbody = document.getElementById('customersTable');
                
                if (customers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üë•</div>
                                    <p class="empty-state-title">Mijozlar yo'q</p>
                                    <p class="text-gray">Yuqoridagi formadan yangi mijoz qo'shing</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = customers.map(customer => `
                    <tr>
                        <td><strong>${customer.name}</strong></td>
                        <td>${customer.additional_name || '-'}</td>
                        <td>${customer.phone || '-'}</td>
                        <td>${customer.address || '-'}</td>
                        <td>
                            <button class="action-btn edit" onclick='editCustomer(${JSON.stringify(customer)})' title="Tahrirlash">
                                ‚úèÔ∏è
                            </button>
                            <button class="action-btn delete" onclick="deleteCustomer(${customer.id})" title="O'chirish">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Mijozlarni yuklashda xatolik:', error);
            }
        }

        function editCustomer(customer) {
            showModal(customer);
        }

        async function saveCustomer() {
            const customerData = {
                name: document.getElementById('customerName').value,
                additional_name: document.getElementById('customerAdditionalName').value || null,
                phone: document.getElementById('customerPhone').value || null,
                address: document.getElementById('customerAddress').value || null,
                latitude: document.getElementById('customerLatitude').value ? parseFloat(document.getElementById('customerLatitude').value) : null,
                longitude: document.getElementById('customerLongitude').value ? parseFloat(document.getElementById('customerLongitude').value) : null
            };

            try {
                if (editingId) {
                    await customersAPI.update(editingId, customerData);
                    showToast('Mijoz yangilandi!', 'success');
                } else {
                    await customersAPI.create(customerData);
                    showToast('Mijoz qo\'shildi!', 'success');
                }
                hideModal();
                loadCustomers();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        }

        // Quick form
        document.getElementById('quickCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerData = {
                name: document.getElementById('quickName').value,
                additional_name: document.getElementById('quickAdditionalName').value || null,
                phone: document.getElementById('quickPhone').value || null,
                address: document.getElementById('quickAddress').value || null
            };

            try {
                await customersAPI.create(customerData);
                showToast('Mijoz qo\'shildi!', 'success');
                document.getElementById('quickCustomerForm').reset();
                loadCustomers();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        });

        async function deleteCustomer(id) {
            if (!confirm('Bu mijozni o\'chirishni xohlaysizmi?')) return;
            
            try {
                await customersAPI.delete(id);
                showToast('Mijoz o\'chirildi', 'success');
                loadCustomers();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize
        loadCustomers();
    </script>
</body>
</html>
