<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savdo - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>if(localStorage.getItem('ngms_sb')==='c')document.documentElement.classList.add('collapsed')</script>
</head>
<body>

<main class="main-content">
    <div class="page-header">
        <div>
            <h1 class="page-title">Savdo</h1>
            <p class="page-subtitle">Savdo ma'lumotlari</p>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-3 mb-4">
        <div class="stat-card accent-green"><p class="stat-label">Kunlik</p><p class="stat-value" id="dailySales">-</p></div>
        <div class="stat-card accent-blue"><p class="stat-label">Oylik</p><p class="stat-value" id="monthlySales">-</p></div>
        <div class="stat-card accent-purple"><p class="stat-label">O'sish</p><p class="stat-value" id="growthPercent">-</p></div>
    </div>

    <!-- Ko'p savdo -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">Ko'p savdo qo'shish</h3>
            <button class="btn btn-sm btn-ghost" onclick="toggleBulk()"><span id="bulkTxt">Ko'rsatish</span></button>
        </div>
        <div class="card-body" id="bulkBox" style="display:none">
            <div id="bulkContainer">
                <div class="bulk-row grid mb-2" style="grid-template-columns:1fr 1fr 70px 100px 100px 120px auto;gap:6px">
                    <select class="form-select bulk-customer"><option value="">Mijoz</option></select>
                    <select class="form-select bulk-product"><option value="">Mahsulot</option></select>
                    <input type="number" class="form-input bulk-quantity" min="1" value="1" placeholder="Miqdor">
                    <input type="number" class="form-input bulk-unit-price" step="100" placeholder="Narx">
                    <input type="number" class="form-input bulk-purchase-price" step="100" placeholder="Tan narx">
                    <input type="date" class="form-input bulk-date">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeBulkRow(this)">√ó</button>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-outline btn-sm" onclick="addBulkRow()">+ Qator</button>
                <button class="btn btn-primary btn-sm" onclick="saveBulkSales()">Saqlash</button>
            </div>
        </div>
    </div>

    <!-- Sales Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Savdolar</h3>
            <div class="flex gap-2">
                <input type="date" id="filterStart" class="form-input" style="width:auto;padding:6px 10px;font-size:12px">
                <input type="date" id="filterEnd" class="form-input" style="width:auto;padding:6px 10px;font-size:12px">
                <button class="btn btn-sm btn-secondary" onclick="filterSales()">Filtr</button>
            </div>
        </div>
        <div class="card-body" style="padding:0">
            <div class="table-container">
                <table class="table">
                    <thead><tr><th>Sana</th><th>Mijoz</th><th>Mahsulot</th><th>Miqdor</th><th>Narx</th><th>Jami</th><th></th></tr></thead>
                    <tbody id="salesTable"><tr><td colspan="7" class="text-center p-4"><div class="spinner" style="margin:0 auto"></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Desktop FAB -->
<button class="fab" id="desktopFab" onclick="openQuickSale()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<!-- Quick Sale Modal -->
<div class="modal" id="quickSaleModal">
    <div class="modal-backdrop" onclick="closeQuickSale()"></div>
    <div class="modal-content" style="max-width:480px">
        <div class="modal-header">
            <h3 class="modal-title">Yangi savdo</h3>
            <button class="modal-close" onclick="closeQuickSale()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="quickSaleForm">
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Mijoz *</label><select id="qCustomer" class="form-select" required><option value="">Tanlang</option></select></div>
                    <div class="form-group"><label class="form-label">Mahsulot *</label><select id="qProduct" class="form-select" required><option value="">Tanlang</option></select></div>
                </div>
                <div class="grid grid-3">
                    <div class="form-group"><label class="form-label">Miqdor *</label><input type="number" id="qQty" class="form-input" min="1" value="1" required></div>
                    <div class="form-group"><label class="form-label">Dona narx *</label><input type="number" id="qPrice" class="form-input" step="100" required><p class="text-gray" style="font-size:10px;margin-top:2px" id="qPriceHint"></p></div>
                    <div class="form-group"><label class="form-label">Sana *</label><input type="date" id="qDate" class="form-input" required></div>
                </div>
                <div class="form-group"><label class="form-label">Tan narx (ixtiyoriy)</label><input type="number" id="qPurchase" class="form-input" step="100" placeholder="Sof foyda uchun"></div>
                <p class="text-gray font-bold mb-4" id="qTotal" style="font-size:13px"></p>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeQuickSale()">Bekor</button>
            <button class="btn btn-primary" onclick="submitQuickSale()">Saqlash</button>
        </div>
    </div>
</div>

<!-- Edit Sale Modal -->
<div class="modal" id="editSaleModal">
    <div class="modal-backdrop" onclick="closeEditModal()"></div>
    <div class="modal-content" style="max-width:480px">
        <div class="modal-header">
            <h3 class="modal-title">Savdoni tahrirlash</h3>
            <button class="modal-close" onclick="closeEditModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="editSaleForm">
                <input type="hidden" id="editSaleId">
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Mijoz *</label><select id="editCustomer" class="form-select" required></select></div>
                    <div class="form-group"><label class="form-label">Mahsulot *</label><select id="editProduct" class="form-select" required></select></div>
                </div>
                <div class="grid grid-3">
                    <div class="form-group"><label class="form-label">Miqdor *</label><input type="number" id="editQty" class="form-input" min="1" required></div>
                    <div class="form-group"><label class="form-label">Dona narx *</label><input type="number" id="editPrice" class="form-input" step="100" required></div>
                    <div class="form-group"><label class="form-label">Sana *</label><input type="date" id="editDate" class="form-input" required></div>
                </div>
                <div class="form-group"><label class="form-label">Tan narx</label><input type="number" id="editPurchase" class="form-input" step="100"></div>
                <p class="text-gray font-bold" id="editTotal" style="font-size:13px"></p>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeEditModal()">Bekor</button>
            <button class="btn btn-primary" onclick="document.getElementById('editSaleForm').requestSubmit()">Saqlash</button>
        </div>
    </div>
</div>

<script src="/static/js/cache.js"></script>
<script src="/static/js/api.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/nav.js"></script>
<script>
var customers=[],products=[];

/* Quick Sale Modal */
function openQuickSale(){document.getElementById('quickSaleModal').classList.add('active')}
function closeQuickSale(){document.getElementById('quickSaleModal').classList.remove('active')}
function closeEditModal(){document.getElementById('editSaleModal').classList.remove('active')}

/* Check hash on load */
if(location.hash==='#add') setTimeout(openQuickSale,300);

/* Toggle bulk */
function toggleBulk(){var b=document.getElementById('bulkBox'),t=document.getElementById('bulkTxt');if(b.style.display==='none'){b.style.display='block';t.textContent='Yashirish'}else{b.style.display='none';t.textContent="Ko'rsatish"}}

/* Load form data */
async function loadFormData(){
    try{
        var r=await Promise.all([customersAPI.getAll(),productsAPI.getAll()]);
        customers=r[0];products=r[1];
        var co='<option value="">Mijoz tanlang</option>'+customers.map(function(c){return '<option value="'+c.id+'">'+c.name+(c.additional_name?' ('+c.additional_name+')':'')+'</option>'}).join('');
        var po='<option value="">Mahsulot tanlang</option>'+products.map(function(p){return '<option value="'+p.id+'" data-price="'+p.sale_price+'">'+p.name+' ('+p.package_type+') ‚Äì '+fmtC(p.sale_price)+'</option>'}).join('');
        document.getElementById('qCustomer').innerHTML=co;
        document.getElementById('qProduct').innerHTML=po;
        document.querySelectorAll('.bulk-customer').forEach(function(e){e.innerHTML=co});
        document.querySelectorAll('.bulk-product').forEach(function(e){e.innerHTML=po});
        document.getElementById('qDate').value=new Date().toISOString().split('T')[0];
        document.querySelectorAll('.bulk-date').forEach(function(e){e.value=new Date().toISOString().split('T')[0]});
        document.getElementById('qProduct').addEventListener('change',function(){
            var s=this.options[this.selectedIndex],p=s.getAttribute('data-price');
            if(p){document.getElementById('qPriceHint').textContent='Narx: '+fmtC(p);document.getElementById('qPrice').value=p}
            else document.getElementById('qPriceHint').textContent='';
            updateQTotal();
        });
    }catch(e){console.error(e)}
}

/* Total hints */
function updateQTotal(){var q=parseInt(document.getElementById('qQty').value)||0,p=parseFloat(document.getElementById('qPrice').value)||0;document.getElementById('qTotal').textContent=q*p>0?'Jami: '+fmtC(q*p):''}
document.getElementById('qQty').addEventListener('input',updateQTotal);
document.getElementById('qPrice').addEventListener('input',updateQTotal);
function updateEditTotal(){var q=parseInt(document.getElementById('editQty').value)||0,p=parseFloat(document.getElementById('editPrice').value)||0;document.getElementById('editTotal').textContent=q*p>0?'Jami: '+fmtC(q*p):''}
document.getElementById('editQty').addEventListener('input',updateEditTotal);
document.getElementById('editPrice').addEventListener('input',updateEditTotal);

/* Submit quick sale */
async function submitQuickSale(){
    var qty=parseInt(document.getElementById('qQty').value)||1,up=parseFloat(document.getElementById('qPrice').value)||0;
    var data={customer_id:parseInt(document.getElementById('qCustomer').value),product_id:parseInt(document.getElementById('qProduct').value),quantity:qty,amount:qty*up,sale_date:document.getElementById('qDate').value};
    var pp=parseFloat(document.getElementById('qPurchase').value);if(!isNaN(pp)&&pp>=0) data.purchase_price_at_sale=pp;
    try{await salesAPI.create(data);showToast("Savdo qo'shildi",'success');closeQuickSale();document.getElementById('quickSaleForm').reset();document.getElementById('qDate').value=new Date().toISOString().split('T')[0];document.getElementById('qTotal').textContent='';loadSales();loadStats()}catch(e){showToast('Xatolik: '+e.message,'error')}
}

/* Stats */
async function loadStats(){
    try{var s=await salesAPI.getStatistics('month');document.getElementById('dailySales').textContent=fmtC(s.total_sales/30);document.getElementById('monthlySales').textContent=fmtC(s.total_sales);document.getElementById('growthPercent').textContent=(s.growth_percent>=0?'+':'')+s.growth_percent.toFixed(1)+'%'}catch(e){console.error(e)}
}

/* Sales list */
async function loadSales(start,end){
    try{
        var sales=await salesAPI.getAll(start,end),tbody=document.getElementById('salesTable');
        if(!sales.length){tbody.innerHTML='<tr><td colspan="7"><div class="empty-state"><p class="empty-state-title">Savdo yo\'q</p></div></td></tr>';return}
        var up=function(s){return s.quantity>0?(s.amount/s.quantity):0};
        tbody.innerHTML=sales.map(function(s){return '<tr><td><strong>'+fmtD(s.sale_date)+'</strong></td><td>'+(s.customer_name||'-')+'</td><td>'+(s.product_name||'-')+'</td><td>'+s.quantity+'</td><td>'+fmtC(up(s))+'</td><td><strong>'+fmtC(s.amount)+'</strong></td><td><button class="action-btn" onclick="openEdit('+s.id+')">‚úèÔ∏è</button> <button class="action-btn" onclick="delSale('+s.id+')">üóë</button></td></tr>'}).join('');
    }catch(e){console.error(e)}
}

function filterSales(){loadSales(document.getElementById('filterStart').value,document.getElementById('filterEnd').value)}

/* Edit */
async function openEdit(id){
    if(!customers.length)return;
    try{
        var s=await salesAPI.getOne(id);
        document.getElementById('editSaleId').value=s.id;
        document.getElementById('editDate').value=s.sale_date||'';
        document.getElementById('editQty').value=s.quantity||1;
        document.getElementById('editPrice').value=s.quantity>0?(s.amount/s.quantity):0;
        document.getElementById('editPurchase').value=s.purchase_price_at_sale!=null?s.purchase_price_at_sale:'';
        document.getElementById('editCustomer').innerHTML='<option value="">Tanlang</option>'+customers.map(function(c){return '<option value="'+c.id+'"'+(c.id===s.customer_id?' selected':'')+'>'+c.name+'</option>'}).join('');
        document.getElementById('editProduct').innerHTML='<option value="">Tanlang</option>'+products.map(function(p){return '<option value="'+p.id+'"'+(p.id===s.product_id?' selected':'')+'>'+p.name+'</option>'}).join('');
        updateEditTotal();
        document.getElementById('editSaleModal').classList.add('active');
    }catch(e){showToast('Xatolik: '+e.message,'error')}
}

document.getElementById('editSaleForm').addEventListener('submit',async function(e){
    e.preventDefault();
    var id=document.getElementById('editSaleId').value;
    var qty=parseInt(document.getElementById('editQty').value)||1;
    var up=parseFloat(document.getElementById('editPrice').value)||0;
    var ppVal=document.getElementById('editPurchase').value;
    var pp=ppVal===''||ppVal===null?null:parseFloat(ppVal);
    var data={
        customer_id:parseInt(document.getElementById('editCustomer').value),
        product_id:parseInt(document.getElementById('editProduct').value),
        quantity:qty,
        amount:qty*up,
        sale_date:document.getElementById('editDate').value,
        purchase_price_at_sale:(pp!==null&&!isNaN(pp)&&pp>=0)?pp:null
    };
    try{
        await salesAPI.update(id,data);
        showToast('Saqlandi','success');
        closeEditModal();
        loadSales();
        loadStats();
    }catch(e){showToast('Xatolik: '+e.message,'error')}
});

async function delSale(id){if(!confirm("O'chirishni xohlaysizmi?"))return;try{await salesAPI.delete(id);showToast("O'chirildi",'success');loadSales();loadStats()}catch(e){showToast('Xatolik: '+e.message,'error')}}

/* Bulk */
function addBulkRow(){
    var co='<option value="">Mijoz</option>'+customers.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>'}).join('');
    var po='<option value="">Mahsulot</option>'+products.map(function(p){return '<option value="'+p.id+'">'+p.name+'</option>'}).join('');
    var r=document.createElement('div');r.className='bulk-row grid mb-2';r.style.gridTemplateColumns='1fr 1fr 70px 100px 100px 120px auto';r.style.gap='6px';
    r.innerHTML='<select class="form-select bulk-customer">'+co+'</select><select class="form-select bulk-product">'+po+'</select><input type="number" class="form-input bulk-quantity" min="1" value="1"><input type="number" class="form-input bulk-unit-price" step="100" placeholder="Narx"><input type="number" class="form-input bulk-purchase-price" step="100" placeholder="Tan narx"><input type="date" class="form-input bulk-date" value="'+new Date().toISOString().split('T')[0]+'"><button type="button" class="btn btn-sm btn-danger" onclick="removeBulkRow(this)">√ó</button>';
    document.getElementById('bulkContainer').appendChild(r);
}
function removeBulkRow(b){if(document.querySelectorAll('.bulk-row').length>1)b.closest('.bulk-row').remove()}
async function saveBulkSales(){
    var rows=document.querySelectorAll('.bulk-row'),arr=[];
    rows.forEach(function(r){var cid=r.querySelector('.bulk-customer').value,pid=r.querySelector('.bulk-product').value,qty=parseInt(r.querySelector('.bulk-quantity').value)||1,up=parseFloat(r.querySelector('.bulk-unit-price').value)||0,pp=r.querySelector('.bulk-purchase-price'),ppv=pp&&pp.value?parseFloat(pp.value):null,dt=r.querySelector('.bulk-date').value;
        if(cid&&pid&&up>0){var it={customer_id:parseInt(cid),product_id:parseInt(pid),quantity:qty,amount:qty*up,sale_date:dt||new Date().toISOString().split('T')[0]};if(ppv!=null&&!isNaN(ppv)&&ppv>=0)it.purchase_price_at_sale=ppv;arr.push(it)}});
    if(!arr.length){showToast("Kamida bitta qator to'ldiring",'error');return}
    try{var r=await salesAPI.bulkImport(arr);showToast(r.message||r.created_count+" ta qo'shildi",'success');loadSales();loadStats()}catch(e){showToast('Xatolik: '+e.message,'error')}
}

/* Init */
loadFormData();loadSales();loadStats();
</script>
</body>
</html>
