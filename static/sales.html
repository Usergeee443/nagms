<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savdo - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><div class="sidebar-logo">NGMS</div></div>
        <nav class="sidebar-nav">
            <a href="/dashboard.html" class="nav-item"><span class="nav-icon">üìä</span>Dashboard</a>
            <a href="/products.html" class="nav-item"><span class="nav-icon">üì¶</span>Mahsulotlar</a>
            <a href="/customers.html" class="nav-item"><span class="nav-icon">üë•</span>Mijozlar</a>
            <a href="/sales.html" class="nav-item active"><span class="nav-icon">üí∞</span>Savdo</a>
            <a href="/maps.html" class="nav-item"><span class="nav-icon">üìç</span>Xaritalar</a>
            <a href="/ai.html" class="nav-item"><span class="nav-icon">ü§ñ</span>AI Tahlil</a>
        </nav>
        <div class="sidebar-footer"><button class="btn btn-danger" style="width:100%" onclick="logout()">Chiqish</button></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Savdo</h1>
                <p class="page-subtitle">Savdo ma'lumotlari va tarixiy yozuvlar</p>
            </div>
        </div>

        <!-- Statistikalar -->
        <div class="grid grid-3 mb-6">
            <div class="stat-card gradient-green">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="stat-label">Kunlik Savdo</p>
                        <p class="stat-value" id="dailySales">0 so'm</p>
                    </div>
                    <span class="stat-icon">üìÖ</span>
                </div>
            </div>
            <div class="stat-card gradient-blue">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="stat-label">Oylik Savdo</p>
                        <p class="stat-value" id="monthlySales">0 so'm</p>
                    </div>
                    <span class="stat-icon">üìà</span>
                </div>
            </div>
            <div class="stat-card gradient-purple">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="stat-label">O'sish</p>
                        <p class="stat-value" id="growthPercent">0%</p>
                    </div>
                    <span class="stat-icon">üìä</span>
                </div>
            </div>
        </div>

        <!-- Tez Savdo Qo'shish -->
        <div class="card mb-6">
            <div class="card-header">
                <h3 class="card-title">‚ö° Tez Savdo Qo'shish</h3>
                <small class="text-gray">Mijoz, mahsulot, miqdor va narxni tanlang. Sana avtomatik saqlanadi.</small>
            </div>
            <div class="card-body">
                <form id="quickSaleForm">
                    <div class="grid grid-3 mb-4">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Mijoz *</label>
                            <select id="quickCustomer" class="form-select" required>
                                <option value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Mahsulot *</label>
                            <select id="quickProduct" class="form-select" required>
                                <option value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Sana *</label>
                            <input type="date" id="quickDate" class="form-input" required>
                        </div>
                    </div>
                    <div class="grid grid-4 mb-4">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Miqdor *</label>
                            <input type="number" id="quickQuantity" class="form-input" min="1" value="1" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Dona narxi (so'm) *</label>
                            <input type="number" id="quickUnitPrice" class="form-input" step="100" required placeholder="5000">
                            <small class="text-gray" id="productPriceHint"></small>
                            <small class="text-gray" id="quickTotalHint" style="display:block; margin-top:4px;"></small>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Oldin tan narxi (ixtiyoriy)</label>
                            <input type="number" id="quickPurchasePrice" class="form-input" step="100" placeholder="Tan narxi qancha bo'lgan">
                            <small class="text-gray">Kiritilsa sof foyda aniq hisoblanadi</small>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                ‚ûï Qo'shish
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ko'p Savdo Qo'shish -->
        <div class="card mb-6">
            <div class="card-header">
                <h3 class="card-title">üìã Ko'p Savdo Qo'shish (Tarixiy ma'lumotlar)</h3>
                <button class="btn btn-sm btn-outline" onclick="toggleBulkForm()">
                    <span id="bulkToggleText">Ko'rsatish</span>
                </button>
            </div>
            <div class="card-body" id="bulkFormContainer" style="display: none;">
                <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <p class="text-gray" style="font-size: 13px;">
                        <strong>üìù Qanday foydalanish:</strong><br>
                        Har bir qatorga bitta savdo ma'lumotini kiriting. Mijoz, mahsulot, miqdor va narxni tanlang.
                    </p>
                </div>
                
                <div id="bulkSalesContainer">
                    <div class="bulk-sale-row grid grid-4 mb-2" style="grid-template-columns: 1fr 1fr 70px 100px 100px 120px auto;">
                        <select class="form-select bulk-customer" required><option value="">Mijoz</option></select>
                        <select class="form-select bulk-product" required><option value="">Mahsulot</option></select>
                        <input type="number" class="form-input bulk-quantity" min="1" value="1" placeholder="Miqdor">
                        <input type="number" class="form-input bulk-unit-price" step="100" placeholder="Dona narxi">
                        <input type="number" class="form-input bulk-purchase-price" step="100" placeholder="Oldin tan narxi" title="Oldin tan narxi (ixtiyoriy)">
                        <input type="date" class="form-input bulk-date">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeBulkRow(this)">‚úï</button>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-4">
                    <button type="button" class="btn btn-outline" onclick="addBulkRow()">
                        ‚ûï Qator qo'shish
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveBulkSales()">
                        üíæ Barchasini saqlash
                    </button>
                </div>
            </div>
        </div>

        <!-- Savdolar Jadvali -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìä Savdolar Ro'yxati</h3>
                <div class="flex gap-2">
                    <input type="date" id="filterStartDate" class="form-input" style="width: auto; padding: 8px 12px;">
                    <input type="date" id="filterEndDate" class="form-input" style="width: auto; padding: 8px 12px;">
                    <button class="btn btn-sm btn-secondary" onclick="filterSales()">Filtrlash</button>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sana</th>
                                <th>Mijoz</th>
                                <th>Mahsulot</th>
                                <th>Miqdor</th>
                                <th>Dona narxi</th>
                                <th>Jami summa</th>
                                <th>Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable">
                            <tr>
                                <td colspan="7" class="text-center p-4">
                                    <div class="spinner" style="margin: 0 auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tahrirlash modali -->
        <div id="editSaleModal" class="modal">
            <div class="modal-backdrop" onclick="closeEditModal()"></div>
            <div class="modal-content" style="max-width: 480px;">
                <div class="modal-header">
                    <h3 class="modal-title">‚úèÔ∏è Savdoni tahrirlash</h3>
                    <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editSaleForm">
                        <input type="hidden" id="editSaleId" value="">
                        <div class="form-group">
                            <label class="form-label">Mijoz *</label>
                            <select id="editCustomer" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mahsulot *</label>
                            <select id="editProduct" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sana *</label>
                            <input type="date" id="editDate" class="form-input" required>
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Miqdor *</label>
                                <input type="number" id="editQuantity" class="form-input" min="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dona narxi (so'm) *</label>
                                <input type="number" id="editUnitPrice" class="form-input" step="100" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Oldin tan narxi (ixtiyoriy)</label>
                            <input type="number" id="editPurchasePrice" class="form-input" step="100" placeholder="Tan narxi qancha bo'lgan">
                        </div>
                        <p class="text-gray" style="font-size: 13px; margin-bottom: 16px;"><span id="editTotalHint">Jami: 0 so'm</span></p>
                        <div class="flex gap-2 justify-end">
                            <button type="button" class="btn btn-outline" onclick="closeEditModal()">Bekor qilish</button>
                            <button type="submit" class="btn btn-primary">Saqlash</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script>
        // Auth check
        if (!getAuthToken()) {
            window.location.href = '/login.html';
        }

        let customers = [];
        let products = [];

        function logout() {
            removeAuthToken();
            window.location.href = '/login.html';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('uz-UZ').format(num || 0);
        }

        function formatCurrency(num) {
            return formatNumber(num) + ' so\'m';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('uz-UZ');
        }

        function toggleBulkForm() {
            const container = document.getElementById('bulkFormContainer');
            const text = document.getElementById('bulkToggleText');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                text.textContent = 'Yashirish';
            } else {
                container.style.display = 'none';
                text.textContent = 'Ko\'rsatish';
            }
        }

        async function loadFormData() {
            try {
                [customers, products] = await Promise.all([
                    customersAPI.getAll(),
                    productsAPI.getAll()
                ]);

                const customerOptions = '<option value="">Mijoz tanlang...</option>' + 
                    customers.map(c => `<option value="${c.id}">${c.name}${c.additional_name ? ' (' + c.additional_name + ')' : ''}</option>`).join('');
                const productOptions = '<option value="">Mahsulot tanlang...</option>' + 
                    products.map(p => `<option value="${p.id}" data-price="${p.sale_price}">${p.name} (${p.package_type}) - ${formatCurrency(p.sale_price)}</option>`).join('');

                document.getElementById('quickCustomer').innerHTML = customerOptions;
                document.getElementById('quickProduct').innerHTML = productOptions;
                
                // Bulk form selects
                document.querySelectorAll('.bulk-customer').forEach(el => el.innerHTML = customerOptions);
                document.querySelectorAll('.bulk-product').forEach(el => el.innerHTML = productOptions);

                // Default date
                document.getElementById('quickDate').value = new Date().toISOString().split('T')[0];
                document.querySelectorAll('.bulk-date').forEach(el => {
                    el.value = new Date().toISOString().split('T')[0];
                });

                // Product price hint
                document.getElementById('quickProduct').addEventListener('change', function() {
                    const selected = this.options[this.selectedIndex];
                    const price = selected.getAttribute('data-price');
                    if (price) {
                        document.getElementById('productPriceHint').textContent = `Belgilangan dona narxi: ${formatCurrency(price)}`;
                        document.getElementById('quickUnitPrice').value = price;
                    } else {
                        document.getElementById('productPriceHint').textContent = '';
                    }
                    if (typeof updateQuickTotalHint === 'function') updateQuickTotalHint();
                });
            } catch (error) {
                console.error('Form ma\'lumotlarini yuklashda xatolik:', error);
            }
        }

        async function loadStatistics() {
            try {
                const stats = await salesAPI.getStatistics('month');
                document.getElementById('dailySales').textContent = formatCurrency(stats.total_sales / 30);
                document.getElementById('monthlySales').textContent = formatCurrency(stats.total_sales);
                document.getElementById('growthPercent').textContent = 
                    (stats.growth_percent >= 0 ? '+' : '') + stats.growth_percent.toFixed(1) + '%';
            } catch (error) {
                console.error('Statistika yuklashda xatolik:', error);
            }
        }

        async function loadSales() {
            try {
                const sales = await salesAPI.getAll();
                const tbody = document.getElementById('salesTable');
                
                if (sales.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üìä</div>
                                    <p class="empty-state-title">Savdo ma'lumotlari yo'q</p>
                                    <p class="text-gray">Yuqoridagi formadan yangi savdo qo'shing</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const unitPrice = (sale) => sale.quantity > 0 ? (sale.amount / sale.quantity) : 0;
                tbody.innerHTML = sales.map(sale => `
                    <tr>
                        <td><strong>${formatDate(sale.sale_date)}</strong></td>
                        <td>${sale.customer_name || '-'}</td>
                        <td>${sale.product_name || '-'}</td>
                        <td>${sale.quantity}</td>
                        <td>${formatCurrency(unitPrice(sale))}</td>
                        <td><strong>${formatCurrency(sale.amount)}</strong></td>
                        <td>
                            <button class="action-btn" onclick="openEditModal(${sale.id})" title="Tahrirlash">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteSale(${sale.id})" title="O'chirish">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Savdolarni yuklashda xatolik:', error);
            }
        }

        async function filterSales() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            try {
                const sales = await salesAPI.getAll(startDate, endDate);
                const tbody = document.getElementById('salesTable');
                
                if (sales.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray">
                                Bu davr uchun savdo topilmadi
                            </td>
                        </tr>
                    `;
                    return;
                }

                const unitPrice = (sale) => sale.quantity > 0 ? (sale.amount / sale.quantity) : 0;
                tbody.innerHTML = sales.map(sale => `
                    <tr>
                        <td><strong>${formatDate(sale.sale_date)}</strong></td>
                        <td>${sale.customer_name || '-'}</td>
                        <td>${sale.product_name || '-'}</td>
                        <td>${sale.quantity}</td>
                        <td>${formatCurrency(unitPrice(sale))}</td>
                        <td><strong>${formatCurrency(sale.amount)}</strong></td>
                        <td>
                            <button class="action-btn" onclick="openEditModal(${sale.id})" title="Tahrirlash">‚úèÔ∏è</button>
                            <button class="action-btn delete" onclick="deleteSale(${sale.id})" title="O'chirish">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Filtrlashda xatolik:', error);
            }
        }

        // Tez savdo: dona narxi * miqdor = jami summa (API ga jami yuboriladi)
        function updateQuickTotalHint() {
            const qty = parseInt(document.getElementById('quickQuantity').value) || 0;
            const price = parseFloat(document.getElementById('quickUnitPrice').value) || 0;
            const total = qty * price;
            const el = document.getElementById('quickTotalHint');
            el.textContent = total > 0 ? `Jami: ${formatCurrency(total)}` : '';
        }
        document.getElementById('quickQuantity').addEventListener('input', updateQuickTotalHint);
        document.getElementById('quickUnitPrice').addEventListener('input', updateQuickTotalHint);

        document.getElementById('quickSaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const quantity = parseInt(document.getElementById('quickQuantity').value) || 1;
            const unitPrice = parseFloat(document.getElementById('quickUnitPrice').value) || 0;
            const totalAmount = quantity * unitPrice;

            const saleData = {
                customer_id: parseInt(document.getElementById('quickCustomer').value),
                product_id: parseInt(document.getElementById('quickProduct').value),
                quantity: quantity,
                amount: totalAmount,
                sale_date: document.getElementById('quickDate').value
            };
            const purchasePrice = parseFloat(document.getElementById('quickPurchasePrice').value);
            if (!isNaN(purchasePrice) && purchasePrice >= 0) {
                saleData.purchase_price_at_sale = purchasePrice;
            }

            try {
                await salesAPI.create(saleData);
                showToast('Savdo muvaffaqiyatli qo\'shildi!', 'success');
                document.getElementById('quickSaleForm').reset();
                document.getElementById('quickDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('productPriceHint').textContent = '';
                document.getElementById('quickTotalHint').textContent = '';
                loadSales();
                loadStatistics();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        });

        function addBulkRow() {
            const container = document.getElementById('bulkSalesContainer');
            const customerOptions = '<option value="">Mijoz</option>' + 
                customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const productOptions = '<option value="">Mahsulot</option>' + 
                products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            const row = document.createElement('div');
            row.className = 'bulk-sale-row grid grid-4 mb-2';
            row.style.gridTemplateColumns = '1fr 1fr 70px 100px 100px 120px auto';
            row.innerHTML = `
                <select class="form-select bulk-customer" required>${customerOptions}</select>
                <select class="form-select bulk-product" required>${productOptions}</select>
                <input type="number" class="form-input bulk-quantity" min="1" value="1" placeholder="Miqdor">
                <input type="number" class="form-input bulk-unit-price" step="100" placeholder="Dona narxi">
                <input type="number" class="form-input bulk-purchase-price" step="100" placeholder="Oldin tan narxi" title="Oldin tan narxi (ixtiyoriy)">
                <input type="date" class="form-input bulk-date" value="${new Date().toISOString().split('T')[0]}">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeBulkRow(this)">‚úï</button>
            `;
            container.appendChild(row);
        }

        function removeBulkRow(btn) {
            const rows = document.querySelectorAll('.bulk-sale-row');
            if (rows.length > 1) {
                btn.closest('.bulk-sale-row').remove();
            }
        }

        async function saveBulkSales() {
            const rows = document.querySelectorAll('.bulk-sale-row');
            const salesArray = [];

            rows.forEach(row => {
                const customerId = row.querySelector('.bulk-customer').value;
                const productId = row.querySelector('.bulk-product').value;
                const quantity = parseInt(row.querySelector('.bulk-quantity').value) || 1;
                const unitPrice = parseFloat(row.querySelector('.bulk-unit-price').value) || 0;
                const purchasePriceEl = row.querySelector('.bulk-purchase-price');
                const purchasePrice = purchasePriceEl && purchasePriceEl.value ? parseFloat(purchasePriceEl.value) : null;
                const date = row.querySelector('.bulk-date').value;

                if (customerId && productId && unitPrice > 0) {
                    const item = {
                        customer_id: parseInt(customerId),
                        product_id: parseInt(productId),
                        quantity: quantity,
                        amount: quantity * unitPrice,
                        sale_date: date || new Date().toISOString().split('T')[0]
                    };
                    if (purchasePrice != null && !isNaN(purchasePrice) && purchasePrice >= 0) {
                        item.purchase_price_at_sale = purchasePrice;
                    }
                    salesArray.push(item);
                }
            });

            if (salesArray.length === 0) {
                showToast('Kamida bitta to\'liq qator kiriting!', 'error');
                return;
            }

            try {
                const result = await salesAPI.bulkImport(salesArray);
                showToast(result.message || `${result.created_count} ta savdo qo'shildi`, 'success');
                
                if (result.errors && result.errors.length > 0) {
                    console.warn('Xatoliklar:', result.errors);
                }
                
                loadSales();
                loadStatistics();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        }

        async function deleteSale(id) {
            if (!confirm('Bu savdoni o\'chirishni xohlaysizmi?')) return;
            
            try {
                await salesAPI.delete(id);
                showToast('Savdo o\'chirildi', 'success');
                loadSales();
                loadStatistics();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        }

        // Tahrirlash modali
        function closeEditModal() {
            document.getElementById('editSaleModal').classList.remove('active');
        }

        function updateEditTotalHint() {
            const qty = parseInt(document.getElementById('editQuantity').value) || 0;
            const price = parseFloat(document.getElementById('editUnitPrice').value) || 0;
            const total = qty * price;
            document.getElementById('editTotalHint').textContent = total > 0 ? `Jami: ${formatCurrency(total)}` : 'Jami: 0 so\'m';
        }

        async function openEditModal(saleId) {
            if (!customers.length || !products.length) {
                showToast('Mijoz va mahsulotlar ro\'yxati yuklanishini kuting', 'error');
                return;
            }
            try {
                const sale = await salesAPI.getOne(saleId);
                document.getElementById('editSaleId').value = sale.id;
                document.getElementById('editDate').value = sale.sale_date || '';
                document.getElementById('editQuantity').value = sale.quantity || 1;
                const unitPrice = sale.quantity > 0 ? (sale.amount / sale.quantity) : 0;
                document.getElementById('editUnitPrice').value = unitPrice;
                document.getElementById('editPurchasePrice').value = (sale.purchase_price_at_sale != null && sale.purchase_price_at_sale !== '') ? sale.purchase_price_at_sale : '';

                const customerOptions = customers.map(c => 
                    `<option value="${c.id}" ${c.id === sale.customer_id ? 'selected' : ''}>${c.name}${c.additional_name ? ' (' + c.additional_name + ')' : ''}</option>`
                ).join('');
                const productOptions = products.map(p => 
                    `<option value="${p.id}" ${p.id === sale.product_id ? 'selected' : ''}>${p.name} (${p.package_type})</option>`
                ).join('');
                document.getElementById('editCustomer').innerHTML = '<option value="">Tanlang...</option>' + customerOptions;
                document.getElementById('editProduct').innerHTML = '<option value="">Tanlang...</option>' + productOptions;

                updateEditTotalHint();
                document.getElementById('editSaleModal').classList.add('active');
            } catch (error) {
                showToast('Savdoni yuklashda xatolik: ' + error.message, 'error');
            }
        }

        document.getElementById('editQuantity').addEventListener('input', updateEditTotalHint);
        document.getElementById('editUnitPrice').addEventListener('input', updateEditTotalHint);

        document.getElementById('editSaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saleId = document.getElementById('editSaleId').value;
            const quantity = parseInt(document.getElementById('editQuantity').value) || 1;
            const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
            const totalAmount = quantity * unitPrice;

            const data = {
                customer_id: parseInt(document.getElementById('editCustomer').value),
                product_id: parseInt(document.getElementById('editProduct').value),
                quantity: quantity,
                amount: totalAmount,
                sale_date: document.getElementById('editDate').value
            };
            const editPurchasePrice = parseFloat(document.getElementById('editPurchasePrice').value);
            if (!isNaN(editPurchasePrice) && editPurchasePrice >= 0) {
                data.purchase_price_at_sale = editPurchasePrice;
            }

            try {
                await salesAPI.update(saleId, data);
                showToast('Savdo saqlandi', 'success');
                closeEditModal();
                loadSales();
                loadStatistics();
            } catch (error) {
                showToast('Xatolik: ' + error.message, 'error');
            }
        });

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize
        loadFormData();
        loadSales();
        loadStatistics();
    </script>
</body>
</html>
