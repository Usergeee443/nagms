<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do'konlar - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>if(localStorage.getItem('ngms_sb')==='c')document.documentElement.classList.add('collapsed')</script>
</head>
<body>

<main class="main-content">
    <div class="page-header">
        <div><h1 class="page-title">Do'konlar</h1><p class="page-subtitle">Barcha do'konlar</p></div>
        <button class="btn btn-primary btn-sm" onclick="showModal()">+ Yangi</button>
    </div>

    <div class="grid grid-3 mb-4">
        <div class="stat-card accent-green"><p class="stat-label">Jami</p><p class="stat-value" id="totalShops">0</p></div>
        <div class="stat-card accent-blue"><p class="stat-label">Faol</p><p class="stat-value" id="activeShops">0</p></div>
        <div class="stat-card accent-orange"><p class="stat-label">Hududlar</p><p class="stat-value" id="totalRegions">0</p></div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><h3 class="card-title">Tez qo'shish</h3></div>
        <div class="card-body">
            <form id="quickShopForm">
                <div class="grid grid-4 mb-3">
                    <div class="form-group" style="margin:0"><label class="form-label">Nomi *</label><input type="text" id="quickName" class="form-input" required placeholder="Do'kon nomi"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Hudud *</label><select id="quickRegion" class="form-select" required><option value="">Tanlang</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Telefon</label><input type="tel" id="quickPhone" class="form-input" placeholder="+998"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Hajmi</label><select id="quickSize" class="form-select"><option value="small">Kichik</option><option value="medium" selected>O'rta</option><option value="large">Katta</option></select></div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">+ Qo'shish</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h3 class="card-title">Do'konlar</h3><span class="badge badge-info" id="shopCount">0</span></div>
        <div class="card-body" style="padding:0">
            <div class="table-container">
                <table class="table">
                    <thead><tr><th>Nomi</th><th>Hudud</th><th>Telefon</th><th>Hajmi</th><th>Status</th><th></th></tr></thead>
                    <tbody id="shopsTable"><tr><td colspan="6" class="text-center p-4"><div class="spinner" style="margin:0 auto"></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div class="modal" id="shopModal">
    <div class="modal-backdrop" onclick="hideModal()"></div>
    <div class="modal-content">
        <div class="modal-header"><h3 class="modal-title" id="modalTitle">Yangi Do'kon</h3><button class="modal-close" onclick="hideModal()">√ó</button></div>
        <div class="modal-body">
            <form id="shopForm">
                <input type="hidden" id="shopId">
                <div class="form-group"><label class="form-label">Nomi *</label><input type="text" id="shopName" class="form-input" required></div>
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Hudud *</label><select id="shopRegion" class="form-select" required><option value="">Tanlang</option></select></div>
                    <div class="form-group"><label class="form-label">Telefon</label><input type="tel" id="shopPhone" class="form-input"></div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Hajmi</label><select id="shopSize" class="form-select"><option value="small">Kichik</option><option value="medium">O'rta</option><option value="large">Katta</option></select></div>
                    <div class="form-group"><label class="form-label">Status</label><select id="shopStatus" class="form-select"><option value="active">Faol</option><option value="passive">Passiv</option></select></div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Latitude</label><input type="number" step="0.0000001" id="shopLatitude" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Longitude</label><input type="number" step="0.0000001" id="shopLongitude" class="form-input"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-outline" onclick="hideModal()">Bekor</button><button class="btn btn-primary" onclick="saveShop()">Saqlash</button></div>
    </div>
</div>

<script src="/static/js/cache.js"></script>
<script src="/static/js/api.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/nav.js"></script>
<script>
var editingId=null,regions=[];
function showModal(s){
    editingId=s?s.id:null;document.getElementById('modalTitle').textContent=s?'Tahrirlash':"Yangi Do'kon";
    if(s){document.getElementById('shopId').value=s.id;document.getElementById('shopName').value=s.name;document.getElementById('shopRegion').value=s.region_id;document.getElementById('shopPhone').value=s.phone||'';document.getElementById('shopSize').value=s.size;document.getElementById('shopStatus').value=s.status;document.getElementById('shopLatitude').value=s.latitude||'';document.getElementById('shopLongitude').value=s.longitude||''}
    else document.getElementById('shopForm').reset();
    document.getElementById('shopModal').classList.add('active');
}
function hideModal(){document.getElementById('shopModal').classList.remove('active');editingId=null}
async function loadFormData(){
    try{regions=await regionsAPI.getAll();document.getElementById('totalRegions').textContent=regions.length;
        var o='<option value="">Tanlang</option>'+regions.map(function(r){return '<option value="'+r.id+'">'+r.name+'</option>'}).join('');
        document.getElementById('quickRegion').innerHTML=o;document.getElementById('shopRegion').innerHTML=o;
    }catch(e){console.error(e)}
}
async function loadShops(){
    try{
        var s=await shopsAPI.getAll();document.getElementById('shopCount').textContent=s.length+' ta';document.getElementById('totalShops').textContent=s.length;document.getElementById('activeShops').textContent=s.filter(function(x){return x.status==='active'}).length;
        var tb=document.getElementById('shopsTable');
        if(!s.length){tb.innerHTML='<tr><td colspan="6"><div class="empty-state"><p class="empty-state-title">Do\'kon yo\'q</p></div></td></tr>';return}
        tb.innerHTML=s.map(function(x){return '<tr><td><strong>'+x.name+'</strong></td><td>'+(x.region_name||'-')+'</td><td>'+(x.phone||'-')+'</td><td><span class="badge '+(x.size==='large'?'badge-success':x.size==='medium'?'badge-info':'badge-warning')+'">'+(x.size==='large'?'Katta':x.size==='medium'?"O'rta":'Kichik')+'</span></td><td><span class="badge '+(x.status==='active'?'badge-success':'badge-danger')+'">'+(x.status==='active'?'Faol':'Passiv')+'</span></td><td><button class="action-btn" onclick=\'showModal('+JSON.stringify(x)+')\'>‚úèÔ∏è</button> <button class="action-btn" onclick="deleteShop('+x.id+')">üóë</button></td></tr>'}).join('');
    }catch(e){console.error(e)}
}
async function saveShop(){
    var d={name:document.getElementById('shopName').value,region_id:parseInt(document.getElementById('shopRegion').value),phone:document.getElementById('shopPhone').value||null,size:document.getElementById('shopSize').value,status:document.getElementById('shopStatus').value,latitude:document.getElementById('shopLatitude').value?parseFloat(document.getElementById('shopLatitude').value):null,longitude:document.getElementById('shopLongitude').value?parseFloat(document.getElementById('shopLongitude').value):null};
    try{if(editingId)await shopsAPI.update(editingId,d),showToast('Yangilandi','success');else await shopsAPI.create(d),showToast("Qo'shildi",'success');hideModal();loadShops()}catch(e){showToast('Xatolik: '+e.message,'error')}
}
document.getElementById('quickShopForm').addEventListener('submit',async function(e){
    e.preventDefault();var d={name:document.getElementById('quickName').value,region_id:parseInt(document.getElementById('quickRegion').value),phone:document.getElementById('quickPhone').value||null,size:document.getElementById('quickSize').value};
    try{await shopsAPI.create(d);showToast("Qo'shildi",'success');this.reset();loadShops()}catch(e){showToast('Xatolik: '+e.message,'error')}
});
async function deleteShop(id){if(!confirm("O'chirishni xohlaysizmi?"))return;try{await shopsAPI.delete(id);showToast("O'chirildi",'success');loadShops()}catch(e){showToast('Xatolik: '+e.message,'error')}}
loadFormData();loadShops();
</script>
</body>
</html>
