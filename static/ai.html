<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tahlil - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><div class="sidebar-logo">NGMS</div></div>
        <nav class="sidebar-nav">
            <a href="/dashboard.html" class="nav-item"><span class="nav-icon">üìä</span>Dashboard</a>
            <a href="/products.html" class="nav-item"><span class="nav-icon">üì¶</span>Mahsulotlar</a>
            <a href="/customers.html" class="nav-item"><span class="nav-icon">üë•</span>Mijozlar</a>
            <a href="/sales.html" class="nav-item"><span class="nav-icon">üí∞</span>Savdo</a>
            <a href="/maps.html" class="nav-item"><span class="nav-icon">üìç</span>Xaritalar</a>
            <a href="/ai.html" class="nav-item active"><span class="nav-icon">ü§ñ</span>AI Tahlil</a>
        </nav>
        <div class="sidebar-footer"><button class="btn btn-danger" style="width:100%" onclick="logout()">Chiqish</button></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">AI Tahlil</h1>
                <p class="page-subtitle">Sun'iy intellekt yordamida biznes tahlili</p>
            </div>
        </div>

        <!-- AI Savol -->
        <div class="card mb-6">
            <div class="card-header">
                <h3 class="card-title">üí¨ AI ga Savol Bering</h3>
            </div>
            <div class="card-body">
                <form id="questionForm">
                    <div class="form-group">
                        <label class="form-label">Savolingizni yozing</label>
                        <textarea id="questionInput" class="form-input" rows="3" 
                            placeholder="Masalan: Qaysi mahsulotlar eng ko'p foyda keltirmoqda? Qaysi hududlarga kengayish kerak?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="askBtn">
                        ü§ñ AI dan so'rash
                    </button>
                </form>
                <div id="answerContainer" class="mt-4" style="display: none;">
                    <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px;">
                        <h4 style="margin-bottom: 12px; color: #166534;">ü§ñ AI Javobi:</h4>
                        <p id="aiAnswer" style="white-space: pre-line; line-height: 1.8;"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tez Tahlillar -->
        <div class="grid grid-2 mb-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Tavsiyalar</h3>
                </div>
                <div class="card-body" id="recommendationsContainer">
                    <div class="spinner" style="margin: 0 auto;"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">‚ö†Ô∏è Xavflar</h3>
                </div>
                <div class="card-body" id="risksContainer">
                    <div class="spinner" style="margin: 0 auto;"></div>
                </div>
            </div>
        </div>

        <!-- Hisobot -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìà Biznes Hisoboti</h3>
                <button class="btn btn-sm btn-secondary" onclick="generateReport()">
                    üîÑ Yangilash
                </button>
            </div>
            <div class="card-body" id="reportContainer">
                <div class="spinner" style="margin: 0 auto;"></div>
            </div>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script>
        // Auth check
        if (!getAuthToken()) {
            window.location.href = '/login.html';
        }

        function logout() {
            removeAuthToken();
            window.location.href = '/login.html';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // Savol berish
        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const question = document.getElementById('questionInput').value.trim();
            if (!question) return;
            
            const btn = document.getElementById('askBtn');
            btn.textContent = 'Kutilmoqda...';
            btn.disabled = true;
            
            try {
                const response = await aiAPI.askQuestion(question);
                document.getElementById('aiAnswer').textContent = response.answer;
                document.getElementById('answerContainer').style.display = 'block';
            } catch (error) {
                document.getElementById('aiAnswer').textContent = 'Xatolik yuz berdi: ' + error.message;
                document.getElementById('answerContainer').style.display = 'block';
            } finally {
                btn.textContent = 'ü§ñ AI dan so\'rash';
                btn.disabled = false;
            }
        });

        async function loadRecommendations() {
            try {
                const response = await aiAPI.getRecommendations();
                document.getElementById('recommendationsContainer').innerHTML = 
                    `<p style="white-space: pre-line; line-height: 1.8;">${response.recommendations}</p>`;
            } catch (error) {
                document.getElementById('recommendationsContainer').innerHTML = 
                    '<p class="text-gray">AI tavsiyalari mavjud emas. OpenAI API key sozlang.</p>';
            }
        }

        async function loadRisks() {
            try {
                const response = await aiAPI.getRisks();
                document.getElementById('risksContainer').innerHTML = 
                    `<p style="white-space: pre-line; line-height: 1.8;">${response.risks}</p>`;
            } catch (error) {
                document.getElementById('risksContainer').innerHTML = 
                    '<p class="text-gray">Xavflar tahlili mavjud emas. OpenAI API key sozlang.</p>';
            }
        }

        async function generateReport() {
            document.getElementById('reportContainer').innerHTML = '<div class="spinner" style="margin: 0 auto;"></div>';
            
            try {
                const response = await aiAPI.generateReport();
                document.getElementById('reportContainer').innerHTML = 
                    `<p style="white-space: pre-line; line-height: 1.8;">${response.report}</p>`;
            } catch (error) {
                document.getElementById('reportContainer').innerHTML = 
                    '<p class="text-gray">Hisobot yaratishda xatolik. OpenAI API key sozlang.</p>';
            }
        }

        // Initialize
        loadRecommendations();
        loadRisks();
        generateReport();
    </script>
</body>
</html>
