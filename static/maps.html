<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xaritalar - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>if(localStorage.getItem('ngms_sb')==='c')document.documentElement.classList.add('collapsed')</script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
</head>
<body>

<main class="main-content">
    <div class="page-header"><div><h1 class="page-title">Xaritalar</h1><p class="page-subtitle">Mijozlar joylashuvi</p></div></div>

    <div class="card mb-4">
        <div class="card-header"><h3 class="card-title">Mijozlar xaritasi</h3><span class="badge badge-info" id="customersMapCount">0 ta</span></div>
        <div class="card-body" style="padding:0"><div id="customersMap" style="height:500px;border-radius:0 0 var(--radius) var(--radius)"></div></div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="flex gap-4 items-center">
                <div class="flex items-center gap-2"><div style="width:12px;height:12px;background:var(--green);border-radius:50%"></div><span style="font-size:12px;color:var(--text-secondary)">Mijoz joylashuvi</span></div>
            </div>
        </div>
    </div>
</main>

<script src="/static/js/cache.js"></script>
<script src="/static/js/api.js"></script>
<script src="/static/js/nav.js"></script>
<script>
var customersMap=null,mapboxToken=null;
async function initMap(){
    try{
        var t=await configAPI.getMapboxToken();mapboxToken=t.token;
        if(!mapboxToken){document.getElementById('customersMap').innerHTML='<div class="empty-state"><p>Mapbox token sozlanmagan</p></div>';return}
        mapboxgl.accessToken=mapboxToken;
        customersMap=new mapboxgl.Map({container:'customersMap',style:'mapbox://styles/mapbox/dark-v11',center:[64.5853,41.3775],zoom:5});
        customersMap.addControl(new mapboxgl.NavigationControl());
        await loadCustomersOnMap();
    }catch(e){console.error(e)}
}
async function loadCustomersOnMap(){
    try{
        var c=await customersAPI.getMapData();document.getElementById('customersMapCount').textContent=c.length+' ta';
        c.forEach(function(x){
            if(!x.latitude||!x.longitude)return;
            var popup=new mapboxgl.Popup({offset:25}).setHTML('<div style="padding:6px;color:#1d1d1f"><strong>'+x.name+'</strong>'+(x.phone?'<br><small>'+x.phone+'</small>':'')+(x.address?'<br><small>'+x.address+'</small>':'')+'</div>');
            var el=document.createElement('div');el.style.cssText='width:20px;height:20px;background:#30d158;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.3);cursor:pointer';
            new mapboxgl.Marker(el).setLngLat([x.longitude,x.latitude]).setPopup(popup).addTo(customersMap);
        });
        if(c.length>0){var b=new mapboxgl.LngLatBounds();c.forEach(function(x){if(x.latitude&&x.longitude)b.extend([x.longitude,x.latitude])});if(!b.isEmpty())customersMap.fitBounds(b,{padding:50})}
    }catch(e){console.error(e)}
}
initMap();
</script>
</body>
</html>
