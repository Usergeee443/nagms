<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahsulotlar - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>if(localStorage.getItem('ngms_sb')==='c')document.documentElement.classList.add('collapsed')</script>
</head>
<body>

<main class="main-content">
    <div class="page-header">
        <div><h1 class="page-title">Mahsulotlar</h1><p class="page-subtitle">Barcha mahsulotlar</p></div>
        <button class="btn btn-primary btn-sm" onclick="showModal()">+ Yangi</button>
    </div>

    <!-- Tez qo'shish -->
    <div class="card mb-4">
        <div class="card-header"><h3 class="card-title">Tez qo'shish</h3></div>
        <div class="card-body">
            <form id="quickProductForm">
                <div class="grid grid-4 mb-3">
                    <div class="form-group" style="margin:0"><label class="form-label">Nomi *</label><input type="text" id="quickName" class="form-input" required placeholder="Mahsulot nomi"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Qadoq *</label><select id="quickPackage" class="form-select" required><option value="">Tanlang</option><option value="250g">250g</option><option value="500g">500g</option><option value="1kg">1kg</option><option value="5kg">5kg</option><option value="10kg">10kg</option><option value="25kg">25kg</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Tan narx *</label><input type="number" id="quickPurchasePrice" class="form-input" step="100" required placeholder="10000"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Sotuv narx *</label><input type="number" id="quickSalePrice" class="form-input" step="100" required placeholder="15000"></div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">+ Qo'shish</button>
            </form>
        </div>
    </div>

    <!-- Jadval -->
    <div class="card">
        <div class="card-header"><h3 class="card-title">Mahsulotlar</h3><span class="badge badge-info" id="productCount">0</span></div>
        <div class="card-body" style="padding:0">
            <div class="table-container">
                <table class="table">
                    <thead><tr><th>Nomi</th><th>Qadoq</th><th>Tan narx</th><th>Sotuv narx</th><th>Foyda %</th><th></th></tr></thead>
                    <tbody id="productsTable"><tr><td colspan="6" class="text-center p-4"><div class="spinner" style="margin:0 auto"></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Modal -->
<div class="modal" id="productModal">
    <div class="modal-backdrop" onclick="hideModal()"></div>
    <div class="modal-content">
        <div class="modal-header"><h3 class="modal-title" id="modalTitle">Yangi Mahsulot</h3><button class="modal-close" onclick="hideModal()">√ó</button></div>
        <div class="modal-body">
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group"><label class="form-label">Nomi *</label><input type="text" id="productName" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Qadoq *</label><select id="productPackage" class="form-select" required><option value="">Tanlang</option><option value="250g">250g</option><option value="500g">500g</option><option value="1kg">1kg</option><option value="5kg">5kg</option><option value="10kg">10kg</option><option value="25kg">25kg</option></select></div>
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Tan narx *</label><input type="number" id="productPurchasePrice" class="form-input" step="100" required></div>
                    <div class="form-group"><label class="form-label">Sotuv narx *</label><input type="number" id="productSalePrice" class="form-input" step="100" required></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-outline" onclick="hideModal()">Bekor</button><button class="btn btn-primary" onclick="saveProduct()">Saqlash</button></div>
    </div>
</div>

<script src="/static/js/cache.js"></script>
<script src="/static/js/api.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/nav.js"></script>
<script>
var editingId=null;

function showModal(p){
    editingId=p?p.id:null;
    document.getElementById('modalTitle').textContent=p?'Tahrirlash':'Yangi Mahsulot';
    if(p){document.getElementById('productId').value=p.id;document.getElementById('productName').value=p.name;document.getElementById('productPackage').value=p.package_type;document.getElementById('productPurchasePrice').value=p.purchase_price;document.getElementById('productSalePrice').value=p.sale_price}
    else document.getElementById('productForm').reset();
    document.getElementById('productModal').classList.add('active');
}
function hideModal(){document.getElementById('productModal').classList.remove('active');editingId=null}

async function loadProducts(){
    try{
        var p=await productsAPI.getAll();document.getElementById('productCount').textContent=p.length+' ta';
        var tb=document.getElementById('productsTable');
        if(!p.length){tb.innerHTML='<tr><td colspan="6"><div class="empty-state"><p class="empty-state-title">Mahsulot yo\'q</p></div></td></tr>';return}
        tb.innerHTML=p.map(function(x){return '<tr><td><strong>'+x.name+'</strong></td><td><span class="badge badge-info">'+x.package_type+'</span></td><td>'+fmt(x.purchase_price)+"</td><td><strong>"+fmt(x.sale_price)+"</strong></td><td><span class='badge badge-success'>"+(x.margin_percent?x.margin_percent.toFixed(1):0)+"%</span></td><td><button class='action-btn' onclick='showModal("+JSON.stringify(x)+")'>‚úèÔ∏è</button> <button class='action-btn' onclick='deleteProduct("+x.id+")'>üóë</button></td></tr>"}).join('');
    }catch(e){console.error(e)}
}
async function saveProduct(){
    var d={name:document.getElementById('productName').value,package_type:document.getElementById('productPackage').value,purchase_price:parseFloat(document.getElementById('productPurchasePrice').value),sale_price:parseFloat(document.getElementById('productSalePrice').value)};
    try{if(editingId)await productsAPI.update(editingId,d),showToast('Yangilandi','success');else await productsAPI.create(d),showToast("Qo'shildi",'success');hideModal();loadProducts()}catch(e){showToast('Xatolik: '+e.message,'error')}
}
document.getElementById('quickProductForm').addEventListener('submit',async function(e){
    e.preventDefault();
    var d={name:document.getElementById('quickName').value,package_type:document.getElementById('quickPackage').value,purchase_price:parseFloat(document.getElementById('quickPurchasePrice').value),sale_price:parseFloat(document.getElementById('quickSalePrice').value)};
    try{await productsAPI.create(d);showToast("Qo'shildi",'success');this.reset();loadProducts()}catch(e){showToast('Xatolik: '+e.message,'error')}
});
async function deleteProduct(id){if(!confirm("O'chirishni xohlaysizmi?"))return;try{await productsAPI.delete(id);showToast("O'chirildi",'success');loadProducts()}catch(e){showToast('Xatolik: '+e.message,'error')}}
loadProducts();
</script>
</body>
</html>
