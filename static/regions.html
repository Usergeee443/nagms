<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hududlar - NGMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>if(localStorage.getItem('ngms_sb')==='c')document.documentElement.classList.add('collapsed')</script>
</head>
<body>

<main class="main-content">
    <div class="page-header">
        <div><h1 class="page-title">Hududlar</h1><p class="page-subtitle">Viloyat, tuman va qishloqlar</p></div>
        <button class="btn btn-primary btn-sm" onclick="showModal()">+ Yangi</button>
    </div>

    <div class="grid grid-3 mb-4">
        <div class="stat-card accent-green"><p class="stat-label">Jami</p><p class="stat-value" id="totalRegions">0</p></div>
        <div class="stat-card accent-blue"><p class="stat-label">Egallangan</p><p class="stat-value" id="occupiedRegions">0</p></div>
        <div class="stat-card accent-purple"><p class="stat-label">Rejalashtirilgan</p><p class="stat-value" id="plannedRegions">0</p></div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><h3 class="card-title">Tez qo'shish</h3></div>
        <div class="card-body">
            <form id="quickRegionForm">
                <div class="grid grid-4 mb-3">
                    <div class="form-group" style="margin:0"><label class="form-label">Nomi *</label><input type="text" id="quickName" class="form-input" required placeholder="Nomi"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Latitude</label><input type="number" step="0.0001" id="quickLatitude" class="form-input" placeholder="39.65"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Longitude</label><input type="number" step="0.0001" id="quickLongitude" class="form-input" placeholder="66.96"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Status</label><select id="quickStatus" class="form-select"><option value="planned">Rejalashtirilgan</option><option value="occupied">Egallangan</option></select></div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">+ Qo'shish</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h3 class="card-title">Hududlar</h3><span class="badge badge-info" id="regionCount">0</span></div>
        <div class="card-body" style="padding:0">
            <div class="table-container">
                <table class="table">
                    <thead><tr><th>Nomi</th><th>Koordinatalar</th><th>Do'konlar</th><th>Status</th><th></th></tr></thead>
                    <tbody id="regionsTable"><tr><td colspan="5" class="text-center p-4"><div class="spinner" style="margin:0 auto"></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div class="modal" id="regionModal">
    <div class="modal-backdrop" onclick="hideModal()"></div>
    <div class="modal-content">
        <div class="modal-header"><h3 class="modal-title" id="modalTitle">Yangi Hudud</h3><button class="modal-close" onclick="hideModal()">√ó</button></div>
        <div class="modal-body">
            <form id="regionForm">
                <input type="hidden" id="regionId">
                <div class="form-group"><label class="form-label">Nomi *</label><input type="text" id="regionName" class="form-input" required></div>
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Latitude</label><input type="number" step="0.0001" id="regionLatitude" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Longitude</label><input type="number" step="0.0001" id="regionLongitude" class="form-input"></div>
                </div>
                <div class="form-group"><label class="form-label">Status</label><select id="regionStatus" class="form-select"><option value="planned">Rejalashtirilgan</option><option value="occupied">Egallangan</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-outline" onclick="hideModal()">Bekor</button><button class="btn btn-primary" onclick="saveRegion()">Saqlash</button></div>
    </div>
</div>

<script src="/static/js/cache.js"></script>
<script src="/static/js/api.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/nav.js"></script>
<script>
var editingId=null;
function showModal(r){
    editingId=r?r.id:null;document.getElementById('modalTitle').textContent=r?'Tahrirlash':'Yangi Hudud';
    if(r){document.getElementById('regionId').value=r.id;document.getElementById('regionName').value=r.name;document.getElementById('regionLatitude').value=r.latitude||'';document.getElementById('regionLongitude').value=r.longitude||'';document.getElementById('regionStatus').value=r.status}
    else document.getElementById('regionForm').reset();
    document.getElementById('regionModal').classList.add('active');
}
function hideModal(){document.getElementById('regionModal').classList.remove('active');editingId=null}
async function loadRegions(){
    try{
        var r=await regionsAPI.getAll();document.getElementById('regionCount').textContent=r.length+' ta';document.getElementById('totalRegions').textContent=r.length;document.getElementById('occupiedRegions').textContent=r.filter(function(x){return x.status==='occupied'}).length;document.getElementById('plannedRegions').textContent=r.filter(function(x){return x.status==='planned'}).length;
        var tb=document.getElementById('regionsTable');
        if(!r.length){tb.innerHTML='<tr><td colspan="5"><div class="empty-state"><p class="empty-state-title">Hudud yo\'q</p></div></td></tr>';return}
        tb.innerHTML=r.map(function(x){return '<tr><td><strong>'+x.name+'</strong></td><td class="text-gray">'+(x.latitude&&x.longitude?x.latitude.toFixed(4)+', '+x.longitude.toFixed(4):'-')+'</td><td><span class="badge badge-info">'+(x.shops_count||0)+' ta</span></td><td><span class="badge '+(x.status==='occupied'?'badge-success':'badge-warning')+'">'+(x.status==='occupied'?'Egallangan':'Reja')+'</span></td><td><button class="action-btn" onclick=\'showModal('+JSON.stringify(x)+')\'>‚úèÔ∏è</button> <button class="action-btn" onclick="deleteRegion('+x.id+')">üóë</button></td></tr>'}).join('');
    }catch(e){console.error(e)}
}
async function saveRegion(){
    var d={name:document.getElementById('regionName').value,latitude:document.getElementById('regionLatitude').value?parseFloat(document.getElementById('regionLatitude').value):null,longitude:document.getElementById('regionLongitude').value?parseFloat(document.getElementById('regionLongitude').value):null,status:document.getElementById('regionStatus').value};
    try{if(editingId)await regionsAPI.update(editingId,d),showToast('Yangilandi','success');else await regionsAPI.create(d),showToast("Qo'shildi",'success');hideModal();loadRegions()}catch(e){showToast('Xatolik: '+e.message,'error')}
}
document.getElementById('quickRegionForm').addEventListener('submit',async function(e){
    e.preventDefault();var d={name:document.getElementById('quickName').value,latitude:document.getElementById('quickLatitude').value?parseFloat(document.getElementById('quickLatitude').value):null,longitude:document.getElementById('quickLongitude').value?parseFloat(document.getElementById('quickLongitude').value):null,status:document.getElementById('quickStatus').value};
    try{await regionsAPI.create(d);showToast("Qo'shildi",'success');this.reset();loadRegions()}catch(e){showToast('Xatolik: '+e.message,'error')}
});
async function deleteRegion(id){if(!confirm("O'chirishni xohlaysizmi?"))return;try{await regionsAPI.delete(id);showToast("O'chirildi",'success');loadRegions()}catch(e){showToast('Xatolik: '+e.message,'error')}}
loadRegions();
</script>
</body>
</html>
